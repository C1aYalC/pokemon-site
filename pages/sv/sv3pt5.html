<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>PoClayMon Set Tracking</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="shortcut icon" sizes="196x196" href="../../lib/imgs/icon.png">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;600;900&display=swap" rel="stylesheet">
        <script src="https://kit.fontawesome.com/e56c958c32.js" crossorigin="anonymous"></script>
        <link href="../../lib/css/global.css" rel="stylesheet">
    </head>
    <body>
        <header class="header" id="mainHeader">
            <div class="container">
                <a href="../../index.html">
                    <img src="../../lib/imgs/c1-pokeball-logo.svg" alt="C1 Logo">
                </a>
            </div>
        </header>
        <main class="container mt-3 p-4">
            <div class="row mb-3 set-info"> 
                <div class="col-12 col-sm-8">
                    <img class="img-fluid" src="../../lib/imgs/set-logos/sv3pt3.png">
                </div>
                <div class="col-12 col-sm-4 align-self-center">
                    <div id="setInfo">
                        <!-- Auto Populated -->
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col set-progress">
                    <div class="progress" role="progressbar" aria-label="Set Completion" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col card-list" id="cardList">
                    <div class="container gx-1">
                        <div class="row">
                            <div id="loading">
                                <img class="d-block mx-auto" width="600" src="../../lib/imgs/loading.png" alt="Your Cards are Loading">
                            </div>
                        </div>
                        <div class="row g-3" id="setCards">
                            <!-- Auto Populated -->
                        </div>
                    </div>
                </div>
                <div class="col-3 d-none">
                    <div class="contatiner">
                        <div class="side-bar-nav mb-3">
                            <div class="accordion" id="sideNavAccordion">
                                <div class="accordion-item mb-3">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#svSets" type="button" aria-expanded="true" aria-controls="svSets">Scarlet & Violet</button>
                                    </h2>
                                    <div id="svSets" class="accordion-collapse collapse show" data-bs-parent="#sideNavAccordion">
                                        <div class="accordion-body">
                                            <ul>
                                                <li>
                                                    <a href="sv1.html" class="current">Base Set</a>
                                                </li>
                                                <li>
                                                    <a href="sv2.html">Paldea Evolved</a>
                                                </li>
                                                <li>
                                                    <a href="sv3.html">Obsidian Flames</a>
                                                </li>
                                                <li>
                                                    <a href="sv3pt5.html">SV 151</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Paradox Rift</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item mb-3">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#swshSets" type="button" aria-expanded="false" aria-controls="swshSets">Sword & Shield</button>
                                    </h2>
                                    <div id="swshSets" class="accordion-collapse collapse" data-bs-parent="#sideNavAccordion">
                                        <div class="accordion-body">
                                            <ul>
                                                <li>
                                                    <a href="sv1.html">Base Set</a>
                                                </li>
                                                <li>
                                                    <a href="sv2.html">Rebel Clash</a>
                                                </li>
                                                <li>
                                                    <a href="sv3.html">Darkness Ablaze</a>
                                                </li>
                                                <li>
                                                    <a href="sv3pt5.html">Champions Path</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Vivid Voltage</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Shining Fates</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Battle Styles</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Chilling Reign</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Evolving Skies</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Celebrations</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Fusion Strike</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Brilliant Stars</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Astral Radiance</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Pokemon GO</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Lost Origin</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Silver Tempest</a>
                                                </li>
                                                <li>
                                                    <a href="sv4.html">Crown Zenith</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Fetch for Card List -->
            <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
            <script>
                const apiKey = 'fafa67e0-50c7-4e86-a4ad-4b936b9b85e4';
                const apiUrlCards = 'https://api.pokemontcg.io/v2/cards';
                const setCodes = ['sv3pt5'];
                const apiUrlSets = `https://api.pokemontcg.io/v2/sets/${setCodes}`;

                function fetchAndDisplaySetInfo() {
                    const setInfoContainer = document.getElementById('setInfo');

                    axios.get(apiUrlSets, {
                            headers: {
                                'X-Api-Key': apiKey,
                            },
                        })
                        .then(response => {
                            const setInfo = response.data.data;
                            displaySetInfo(setInfoContainer, setInfo);
                        })
                        .catch(error => {
                            console.error(error);
                        });
                }

                function displaySetInfo(container, setInfo) {

                    const releaseDate = new Date(setInfo.releaseDate);
                    const formattedReleaseDate = `${releaseDate.getMonth() + 1}/${releaseDate.getDate()}/${releaseDate.getFullYear()}`;

                    const setInfoElement = document.createElement('div');
                    setInfoElement.setAttribute('class', 'set-details');
                    setInfoElement.innerHTML = `
                        <p class="set-name h1">${setInfo.name}</p>    
                        <img src=${setInfo.images.symbol} alt="${setInfo.name} Set Symbol">
                        <p><span class="fa fa-layer-group"></span>Total Cards: <strong>${setInfo.total}</strong> (${setInfo.printedTotal})</p>
                        <p class="mt-2"><span class="fa fa-calendar"></span>Release Date: <strong>${formattedReleaseDate}</strong></p>
                    `;
                    container.appendChild(setInfoElement);
                }

                fetchAndDisplaySetInfo();

                function fetchAndDisplaySetCards() {
                    const setCardsContainer = document.getElementById('setCards');

                    setCardsContainer.innerHTML = '';

                    setCodes.forEach(setCode => {
                        let currentPage = 1;

                        const fetchAllPages = () => {
                            const setApiUrl = `${apiUrlCards}?q=set.id:${setCode}&page=${currentPage}&orderBy=number`;

                            axios.get(setApiUrl, {
                                    headers: {
                                        'X-Api-Key': apiKey,
                                    },
                                })
                                .then(response => {
                                    const cards = response.data.data;
                                    displaySetCards(setCardsContainer, cards);

                                    const totalCards = response.data.totalCount;
                                    let cardCount = response.data.count;
                                    if (cardCount < totalCards) {
                                        currentPage++;
                                        fetchAllPages();
                                    }
                                })
                                .catch(error => {
                                    console.error(error);
                                });
                        };

                        fetchAllPages();
                    });
                }

                function displaySetCards(container, cards) {
                    cards.forEach(card => {
                        const cardRarities = ['Rare', 'Uncommon', 'Common'];
                        const baseCardRarity = cardRarities.includes(card.rarity);

                        const originalNumber = card.number;
                        const formattedNumber = originalNumber.toString().padStart(3, '0');

                        const cardName = card.name;
                        const formatedCardName = cardName.replace(/ /g, '_').replace(/[()]/g, '').replace(/'/g, '').replace(/\./g, '');

                        const cardId = card.id;
                        const cardSetId = card.set.id;
                        const cardImgUrl = "https://images.pokemontcg.io";
                        const cardImgHiResUrl = `${cardImgUrl}/${cardSetId}/${originalNumber}_hires.png`;

                        const cardElement = document.createElement('div');
                        cardElement.setAttribute('class', `col-6 col-md-2 ${card.name} card-container`);
                        cardElement.innerHTML = `
                            <div class="card">
                                <img src="${card.images.small}" type="button" class="btn btn-primary" alt="${card.name}" data-bs-toggle="modal" data-bs-target="#${cardId}Modal" loading="lazy">
                                <div class="card-check">
                                    <input class="card-check-input form-check-input" id="${cardId}Input" type="checkbox" onchange="updateProgressBar()">
                                </div>
                                <div class="container card-details">
                                    <div class="row card-info">
                                        <div class="col-12 col-sm-8 pe-sm-0 text-center text-sm-start">
                                            <p class="card-name">${card.name}</p>
                                        </div>
                                        <div class="col-12 col-sm-4 ps-sm-0 text-center text-sm-end align-items-end">
                                            <p class="card-price">$${card.cardmarket.prices.averageSellPrice}</p>
                                        </div>
                                    </div>
                                    <div class="row card-info">
                                        <div class="col-sm-3 d-none d-sm-block pe-0 text-start">
                                            <p class="card-number">#${formattedNumber}</p>
                                        </div>
                                        <div class="col-sm-9 d-none d-sm-block ps-0 text-end align-items-end">
                                            <p class="card-rarity">${card.rarity}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        container.appendChild(cardElement);

                        const modalElement = document.createElement('div');
                        modalElement.setAttribute('class',`modalContainer-${cardId} modal fade ${formatedCardName}Modal`);
                        modalElement.setAttribute('id',`${cardId}Modal`);
                        modalElement.setAttribute('tabIndex','-1');
                        modalElement.setAttribute('aria-labelledby',`${cardId}ModalLabel`);
                        modalElement.setAttribute('aria-hidden','true');
                        modalElement.innerHTML = `
                                <div class="modal-dialog modal-xl">
                                    <div class="modal-content">
                                        <div class="modal-header container d-flex align-items-center justify-content-end pb-0">
                                            <div class="row">
                                                <div class="modal-close" data-bs-dismiss="modal" aria-label="Close">
                                                    <span type="button" class="fa fa-xmark"></span>  
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-body">
                                            <div class="container">
                                                <div class="row">
                                                    <div class="col-12 col-md-5">
                                                        <img src="${card.images.large}" alt="${card.name}" loading="lazy" width="100%">
                                                    </div>
                                                    <div class="col-12 col-md-7">
                                                        <div class="container">
                                                            <div class="row">
                                                                <div class="col">
                                                                    <p class="card-name modal-title d-flex align-items-center" id="${formatedCardName}ModalLabel">${card.name}</p>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col">
                                                                    <p class="modal-card-number d-flex align-items-center">
                                                                        <img src=${card.set.images.symbol} alt="${card.set.name} Set Symbol">
                                                                        #${formattedNumber}/${card.set.printedTotal}
                                                                    </p>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col">
                                                                    <p class="modal-card-artist"><span class="fa fa-paintbrush"></span>
                                                                        Artist:<span class="artist-name">${card.artist}</span>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
                        container.appendChild(modalElement);
                    });
                    }
                fetchAndDisplaySetCards();

                setTimeout(function() {
                    document.getElementById('loading').remove();
                }, 10000);

                window.addEventListener('scroll', function() {
                    var header = document.getElementById('mainHeader');
                    var targetDiv = document.getElementById('cardList');

                    var targetDivTop = targetDiv.getBoundingClientRect().top;
                    
                    if (window.innerWidth <= 767){
                        if (targetDivTop <= 0) {
                            header.classList.add('sticky');
                        } else {
                            header.classList.remove('sticky');
                        }
                    }
                });

                function updateProgressBar() {
                    var checkboxes = document.querySelectorAll('.card-check-input');
                    var filledPercentage = calculateFilledPercentage(checkboxes);
                    updateProgressBarWidth(filledPercentage);
                    saveCheckboxStates(checkboxes);
                }

                function calculateFilledPercentage(checkboxes) {
                    var checkedCount = 0;
                    checkboxes.forEach(function(checkbox) {
                        if (checkbox.checked) {
                            checkedCount++;
                        }
                    });
                    var totalCheckboxes = checkboxes.length;
                    return (checkedCount / totalCheckboxes) * 100;
                }

                function updateProgressBarWidth(percentage) {
                    var progressBar = document.getElementById('progressBar');
                    progressBar.style.width = percentage + '%';
                    progressBar.setAttribute('aria-valuenow', percentage);
                }

                function saveCheckboxStates(checkboxes) {
                    var checkboxStates = {};
                    checkboxes.forEach(function(checkbox) {
                        checkboxStates[checkbox.id] = checkbox.checked;
                    });
                    localStorage.setItem('checkboxStates', JSON.stringify(checkboxStates));
                }

                function loadCheckboxStates(checkboxes) {
                    var storedStates = localStorage.getItem('checkboxStates');
                    if (storedStates) {
                        var checkboxStates = JSON.parse(storedStates);
                        checkboxes.forEach(function(checkbox) {
                            if (checkboxStates.hasOwnProperty(checkbox.id)) {
                                checkbox.checked = checkboxStates[checkbox.id];
                            }
                        });
                    }
                }

                function runUpdateScript() {
                    function checkAndRun() {
                        var setCardsDiv = document.getElementById('setCards');
                        var checkboxes = setCardsDiv.querySelectorAll('.card-check-input');
                        if (setCardsDiv && checkboxes.length > 0) {
                            loadCheckboxStates(checkboxes);
                            updateProgressBar();
                            checkboxes.forEach(function(checkbox) {
                                checkbox.addEventListener('click', function() {
                                    saveCheckboxStates(checkboxes);
                                });
                            });
                        } else {
                            setTimeout(checkAndRun, 100);
                        }
                    }
                    checkAndRun();
                }
                runUpdateScript();
                
                function checkAllCheckboxes() {
                    var checkboxes = document.querySelectorAll('.card-check-input');
                    checkboxes.forEach(function (checkbox) {
                    checkbox.checked = true;
                    });
                }

                // Event listener for the "Check All Checkboxes" button
                var checkAllButton = document.getElementById('checkAllButton');
                if (checkAllButton) {
                    checkAllButton.addEventListener('click', function () {
                    checkAllCheckboxes();
                    });
                }
            </script>
        </main>
    </body>
</html>